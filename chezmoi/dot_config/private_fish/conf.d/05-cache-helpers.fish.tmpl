{{ template "banner.tmpl" "Fish - Cache Helpers" }}

# --- Cache System for Tool Initialization
# -----------------------------------------------------------------------------
# This provides helpers to cache expensive tool initialization commands,
# significantly improving shell startup performance.
#
# Cached files are stored in $XDG_CONFIG_HOME/fish/conf.d/ with the
# prefix "99-cached-" so they are auto-loaded by Fish at the end of startup.

set --global __fish_cache_dir "$__fish_config_dir/conf.d"

# Helper function to cache tool initialization
# Usage: __fish_cache_init "tool_name" "init_command"
function __fish_cache_init --description "Cache tool initialization output"
  set --local tool_name $argv[1]
  set --local init_command $argv[2..-1]
  set --local cache_file "$__fish_cache_dir/99-cached-$tool_name.fish"

  # Get tool path and modification time for cache invalidation
  set --local tool_path (command -v $tool_name 2>/dev/null)

  if test -z "$tool_path"
    return 1
  end

  # Check if cache exists and is newer than the tool binary
  if not test -f "$cache_file" -o "$tool_path" -nt "$cache_file"
    # Cache is invalid or doesn't exist, regenerate it
    eval $init_command > "$cache_file"
  end
end
